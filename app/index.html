<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Sgtoolkit</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    {{content-for "head"}}

    <link integrity="" rel="stylesheet" href="{{rootURL}}assets/vendor.css">
    <link integrity="" rel="stylesheet" href="{{rootURL}}assets/sgtoolkit.css">

    {{content-for "head-footer"}}
  </head>
  <body>
    {{content-for "body"}}

    <!--Bootstrap JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.bundle.js"></script>
    <script src="{{rootURL}}assets/vendor.js"></script>
    <script src="{{rootURL}}assets/sgtoolkit.js"></script>

    <script type="text/javascript">
      // Create an immediately invoked functional expression to wrap our code
      (function() {
        // Define our constructor
        this.Timeline = function() {
          // Define option defaults
          var defaults = {
            scale: 3,
            labelFormat:"ha",
            periodLength:60,
            totalPeriods:24,
          }

          // Create options by extending defaults with the passed in arguments
          this.options = extendDefaults(defaults, arguments[0]);
          // Auto initialise the plugin
          this.init();
        }

        // Public Methods

        Timeline.prototype.init = function() {
          // open code goes here
          const options = this.options;
          /* global moment */
          document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('[data-timeline]').forEach(tl => {
              const scale = tl.dataset.scale ? tl.dataset.scale : this.options.scale,
                timelineStarts = tl.dataset.starts,
                labelFormat = tl.dataset.periodLabelFormat ? tl.dataset.periodLabelFormat : this.options.labelFormat,
                periodLength = tl.dataset.periodLength ? tl.dataset.periodLength : this.options.periodLength,
                totalPeriods = tl.dataset.totalPeriods ? tl.dataset.totalPeriods : this.options.totalPeriods,
                minsPerRem = periodLength/scale; // mins per 1rem unit

              // check timelinet start date is defined
              if (!timelineStarts) {
                throw Error("You must define a start date for the timeline via the data-starts attribute")
              }

              let time = moment(timelineStarts);



              for (var p = 0; p < totalPeriods; p++) {

                let label = (p === 0 ? "" : time.format(labelFormat)),
                  first = (p === 0 ? "first" : ""),
                  last = (p === (totalPeriods - 1) ? "last" : "");

                let period = tl.insertAdjacentHTML('beforeend', `<div class="timeline__period ${first} ${last}" style="width:${scale}rem;"><div class="timeline__label">${label}</div></div>`);

                time.add(periodLength, 'm'); // add period duration in mins to running time
              }


              tl.querySelectorAll('.timeline__event').forEach(ev => {

                const starts = ev.dataset.starts,
                  ends = ev.dataset.ends;

                if (!starts) {
                  console.warn("No start time defined for the timeline period via the data-starts attribute. This period was skipped")
                } else if (!ends) {
                  console.warn("No end time defined for the timeline period via the data-ends attribute. This period was skipped")
                } else {

                  const duration = moment.duration(moment(ends).diff(moment(starts))).asMinutes(),
                    offset = moment.duration(moment(starts).diff(moment(timelineStarts))).asMinutes();

                  let x = (offset / minsPerRem),
                    w = (duration / minsPerRem);

                  ev.style.transform = `translateX(${x}rem)`;
                  ev.style.width = `${w}rem`;
                }
              })
            });
          });
        }

        // Private Methods

        // Utility method to extend defaults with user options
        function extendDefaults(source, properties) {
          var property;
          for (property in properties) {
            if (properties.hasOwnProperty(property)) {
              source[property] = properties[property];
            }
          }
          return source;
        }
      }());
    </script>
    <script type="text/javascript">
    var timeline = new Timeline();
    </script>
    {{content-for "body-footer"}}
  </body>
</html>
